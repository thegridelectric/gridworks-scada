<!DOCTYPE html>
<html>
<head>
    <title>Relay Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Fixed Status Bar -->
    <div id="status" style="position: fixed; top: 0; left: 0; right: 0; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); padding: 8px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 1000;">
        <div id="status-left">Connecting...</div>
        <div id="status-right"></div>
    </div>
    
    <!-- Main Content with top padding to account for fixed header -->
    <div style="padding-top: 60px;">
        <h1 style="text-align: center; margin-top: 30px; margin-bottom: 20px;">Admin panel</h1>
    
    <!-- Control Panel -->
    <div id="control-panel" style="text-align: center; max-width: 770px; margin: 0px auto 20px auto; background-color: transparent; border: 0px solid #ddd; border-radius: 3px; padding: 20px;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
            <div id="timer-display" style="font-family: monospace; font-size: 25px; color: #333; font-weight: bold; margin-right: 20px;">00:00:00</div>
            <div style="display: inline-block;">
                <label for="timeout-input">Timeout (minutes):</label>
                <input type="number" id="timeout-input" value="5" min="1" max="1440" style="width: 60px; margin: 0 5px; padding: 8px 14px; border: 1px solid var(--border-color); border-radius: 0.25rem; background-color: white; font-family: inherit; font-size: inherit;">
            </div>
            <button id="keep-alive-btn" onclick="sendKeepAlive()" style="margin: 0 5px; padding: 8px 14px; border: 1px solid var(--border-color); border-radius: 0.25rem; background-color: #FAFAFA; cursor: pointer; font-family: inherit; font-size: inherit;">Keep alive</button>
            <button id="release-control-btn" onclick="sendReleaseControl()" style="margin: 0 5px; padding: 8px 14px; border: 1px solid var(--border-color); border-radius: 0.25rem; background-color: #FAFAFA; cursor: pointer; font-family: inherit; font-size: inherit;">Release control</button>
        </div>
        <!-- <div id="control-status" style="font-size: 14px; margin: 5px 0; color: #666;">No control</div> -->
    </div>
    
    <div id="relays" style="margin-bottom: 40px;"></div>
    
    <h1 style="text-align: center; margin-top: 30px; margin-bottom: 40px;">Dashboard</h1>
    
    <!-- System Monitoring Tables -->
    <div id="monitoring-tables" style="max-width: 1400px; margin: 20px auto 40px auto; display: flex; flex-wrap: wrap; gap: 30px; justify-content: center;">
        <!-- Thermostats and Hot Water Table -->
        <div>
            <table id="thermostat-table" style="border: 1px solid var(--border-color); border-collapse: collapse; border-radius: 0.25rem; background-color: var(--card-background); margin: 0 auto;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">Thermostats</th>
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">Setpoint</th>
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">Temperature</th>
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">State</th>
                    </tr>
                </thead>
                <tbody id="thermostat-tbody">
                    <tr>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- HP Power Table -->
        <div>
            <table id="hp-power-table" style="border: 1px solid var(--border-color); border-collapse: collapse; border-radius: 0.25rem; background-color: var(--card-background); margin: 0 auto;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">Heat pump</th>
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">kW</th>
                    </tr>
                </thead>
                <tbody id="hp-power-tbody">
                    <tr>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pump Table -->
        <div>
            <table id="pump-table" style="border: 1px solid var(--border-color); border-collapse: collapse; border-radius: 0.25rem; background-color: var(--card-background); margin: 0 auto;">
                <thead>
                    <tr style="background-color: #f0f0f0;">
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">Pumps</th>
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">GPM</th>
                        <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left; font-weight: bold;">W</th>
                    </tr>
                </thead>
                <tbody id="pump-tbody">
                    <tr>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                        <td style="border: 1px solid var(--border-color); padding: 8px;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- System State Information -->
    <div id="system-state" style="text-align: center; max-width: 1000px; margin: 20px auto 20px auto; background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 0.25rem; padding: 20px;">
        <div id="hp-state" style="font-size: 18px; font-weight: 600; color: var(--text-color);">Determining state...</div>
        <div id="storage-state" style="font-size: 18px; font-weight: 600; color: var(--text-color);">Determining state...</div>
        <div id="combined-state" style="font-size: 20px; font-weight: 700; color: var(--text-color);">Determining state...</div>
    </div>

    <style>
        :root {
            /* Dark mode colors (default) */
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --datetime-background: #f1f3f5;
            --datetime-text: #1b1b1c;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-color: #f1f3f5;
        }

        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
            font-size: 14px;
            margin: 0;
            padding: 0;
        }

        table tr:hover {
            background-color: var(--hover-color);
        }
    </style>


    <script>
        let websocket = null;
        let relays = {};
        let thermostatNames = [];
        let currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//visualizer.electricity.works:8080/ws`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                document.getElementById('status-left').textContent = 'Connected';
                document.getElementById('status-right').textContent = '';
                console.log('WebSocket connected');
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
            
            websocket.onclose = function(event) {
                document.getElementById('status-left').textContent = 'Disconnected';
                document.getElementById('status-right').textContent = 'Please refresh the page';
                console.log('WebSocket disconnected');
                
                // Clear the relay table and show disconnected message
                const relaysDiv = document.getElementById('relays');
                relaysDiv.innerHTML = '';
                const controlPanel = document.getElementById('control-panel');
                controlPanel.innerHTML = '';
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                document.getElementById('status-left').textContent = 'Error';
                document.getElementById('status-right').textContent = 'Connection failed';
            };
        }

        function handleMessage(data) {
            console.log('Received message:', data);
            
            if (data.type === 'status') {
                updateStatus(data);
            } else if (data.type === 'timer_update') {
                updateTimer(data);
            } else if (data.type === 'mqtt_message') {
                // Handle MQTT messages (could be relay state updates)
                if (data.message_type === 'single.reading') {
                    updateRelayState(data.payload);
                } else if (data.message_type === 'snapshot.spaceheat') {
                    updateMonitoringTables(data.payload);
                }
            } else if (data.type === 'error') {
                console.error('Error: ' + data.message);
            }
        }

        function updateStatus(data) {
            // Build status for left and right sides
            let leftStatus = '';
            let rightStatus = '';
            
            // Left side: target_gnode (bold)
            const gnodeParts = data.target_gnode ? data.target_gnode.split('.') : [];
            const beforeLastPart = gnodeParts.length > 1 ? gnodeParts[gnodeParts.length - 2] : '';
            const capitalizedPart = beforeLastPart.charAt(0).toUpperCase() + beforeLastPart.slice(1);
            if (data.target_gnode) {
                leftStatus = `<b style="font-size: 1.5em;">${capitalizedPart}</b>`;
            }
            
            // Right side: full gnode
            if (data.target_gnode) {
                rightStatus = `<span style="color: var(--text-muted); font-size: 1em;">${data.target_gnode}</span>`;
            }

            
            // Second line: MQTT connection status and message count
            // if (data.mqtt_connected) {
            //     statusText += 'MQTT broker connection: active';
            // } else {
            //     statusText += 'MQTT broker connection: inactive';
            // }
            
            // if (data.messages_received !== undefined) {
            //     statusText += ` | Messages received: ${data.messages_received}`;
            // }
            
            document.getElementById('status-left').innerHTML = leftStatus;
            document.getElementById('status-right').innerHTML = rightStatus;
            
            // Update relays
            if (data.relays) {
                relays = data.relays;
                updateRelayButtons();
            }
            
            // Update thermostat names
            if (data.thermostat_names) {
                thermostatNames = data.thermostat_names;
                console.log('Updated thermostat names:', thermostatNames);
            }
            
            // Update timer from status
            if (data.time_remaining !== undefined) {
                updateTimer({ time_remaining: data.time_remaining, controller: data.controller });
            }
        }
        
        function updateTimer(data) {
            const hours = Math.floor(data.time_remaining / 3600);
            const minutes = Math.floor((data.time_remaining % 3600) / 60);
            const seconds = Math.floor(data.time_remaining % 60);
            
            const timerElement = document.getElementById('timer-display');
            timerElement.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color based on timer state
            if (data.time_remaining > 0) {
                timerElement.style.color = '#CC1616';
            } else {
                timerElement.style.color = '#333';
            }
            
            // Show who has control
            // if (data.controller) {
            //     const isCurrentUser = data.controller === currentUserId;
            //     document.getElementById('control-status').textContent = 
            //         // `Control: ${data.controller}${isCurrentUser ? ' (You)' : ''}`;
            //         `Last action done by ${isCurrentUser ? ' you' : 'another user'}`;
            //     } else {
            //     document.getElementById('control-status').textContent = 'No control';
            // }
        }

        function updateRelayButtons() {
            const relaysDiv = document.getElementById('relays');
            relaysDiv.innerHTML = '';
            
            // Create table
            const table = document.createElement('table');
            table.style.border = '1px solid var(--border-color)';
            table.style.borderCollapse = 'collapse';
            table.style.borderRadius = '0.25rem';
            table.style.maxWidth = '1000px';
            table.style.margin = '0 auto'; // Center horizontally
            table.style.backgroundColor = 'var(--card-background)';
            
            // Create header row
            const headerRow = document.createElement('tr');
            const headers = ['Relay', 'Name', 'Current State', 'Action', 'Energized'];
            headers.forEach((headerText, index) => {
                const th = document.createElement('th');
                th.textContent = headerText;
                // th.style.border = '1px solid var(--border-color)';
                th.style.padding = '8px 10px';
                th.style.backgroundColor = '#f0f0f0';
                
                // Set fixed width for "Current State" column (index 2)
                if (index === 2) {
                    th.style.width = '170px';
                }
                
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);
            
            // Sort relays by relay number
            const sortedRelays = Object.entries(relays).sort((a, b) => {
                const relayNumberA = parseInt(a[0].replace('relay', ''));
                const relayNumberB = parseInt(b[0].replace('relay', ''));
                return relayNumberA - relayNumberB;
            });
            
            // Create data rows
            for (const [relayName, relayInfo] of sortedRelays) {
                const row = document.createElement('tr');
                
                // Extract relay number from relay name (e.g., "relay1" -> "1")
                const relayNumber = relayName.replace('relay', '');
                
                // Get current state
                const currentState = relayInfo.state || 'unknown';
                
                // Get the actual state description for this relay
                let currentStateDescription = 'unknown';
                if (currentState === 'energized') {
                    currentStateDescription = relayInfo.energized_state || 'energized';
                } else if (currentState === 'deenergized') {
                    currentStateDescription = relayInfo.deenergized_state || 'deenergized';
                }
                
                // Determine action text based on current state using actual event names
                let actionText = 'unknown';
                if (currentState === 'energized') {
                    actionText = relayInfo.de_energizing_event || 'De-energize';
                } else if (currentState === 'deenergized') {
                    actionText = relayInfo.energizing_event || 'Energize';
                }
                
                // Determine energized icon
                const energizedIcon = currentState === 'energized' ? 'ðŸ”´' : 'âšª';
                
                // Create cells
                const cells = [
                    relayNumber,
                    relayInfo.display_name.replace(/Relay\s*/i, ''),
                    currentStateDescription,
                    actionText,
                    energizedIcon
                ];
                
                cells.forEach((cellText, index) => {
                    const td = document.createElement('td');
                    // Only show left and right borders for data cells (no top/bottom borders between rows)
                    // td.style.borderLeft = '1px solid var(--border-color)';
                    // td.style.borderRight = '1px solid var(--border-color)';
                    td.style.padding = '2px 16px';
                    
                    if (index === 3) { // Action column - make it clickable
                        const button = document.createElement('button');
                        button.textContent = cellText;
                        button.onclick = () => toggleRelay(relayName);
                        button.style.width = '200px';
                        button.style.padding = '3px 14px';
                        button.style.border = '1px solid var(--border-color)';
                        button.style.borderRadius = '0.25rem';
                        button.style.backgroundColor = currentState === 'energized' ? '#FAFAFA' : '#FAFAFA';
                        button.style.cursor = 'pointer';
                        button.style.fontFamily = 'inherit';
                        button.style.fontSize = 'inherit';
                        td.appendChild(button);
                    } else if (index === 4) { // Energized column - center the content
                        td.textContent = cellText;
                        td.style.textAlign = 'center';
                    } else {
                        td.textContent = cellText;
                    }
                    
                    row.appendChild(td);
                });
                
                table.appendChild(row);
            }
            
            // Add bottom border to the last row
            if (sortedRelays.length > 0) {
                const lastRow = table.rows[table.rows.length - 1];
                for (let i = 0; i < lastRow.cells.length; i++) {
                    lastRow.cells[i].style.borderBottom = '1px solid var(--border-color)';
                }
            }
            
            relaysDiv.appendChild(table);
            
            // Update system state after updating relay buttons
            updateSystemState();
        }

        function updateSystemState() {
            const hpStateElement = document.getElementById('hp-state');
            const storageStateElement = document.getElementById('storage-state');
            const combinedStateElement = document.getElementById('combined-state');
            
            // Check if we have relay 5 and relay 6 data for HP state
            const relay5 = relays['relay5'];
            const relay6 = relays['relay6'];
            
            let hpState = '';
            let hpStateColor = 'var(--text-color)';
            let hpOn = false;
            
            if (!relay5 || !relay6) {
                hpStateElement.textContent = 'Waiting for relay data...';
                hpStateElement.style.color = 'var(--text-muted)';
            } else {
                const relay5State = relay5.state;
                const relay6State = relay6.state;
                
                if (relay5State === 'energized' && relay6State === 'deenergized') {
                    hpState = 'HP on';
                    hpStateColor = '#28a745'; // Green for "on"
                    hpOn = true;
                } else if (relay5State === 'energized' && relay6State === 'energized') {
                    hpState = 'HP off';
                    hpStateColor = '#dc3545'; // Red for "off"
                    hpOn = false;
                } else if (relay5State === 'deenergized') {
                    hpState = 'HP in tank aquastat';
                    hpStateColor = '#ffc107'; // Yellow for "aquastat"
                    hpOn = false;
                } else {
                    hpState = 'Unknown state';
                    hpStateColor = 'var(--text-muted)';
                }
                
                hpStateElement.textContent = hpState;
                hpStateElement.style.color = hpStateColor;
            }
            
            // Check if we have relay 3 and relay 9 data for storage state
            const relay3 = relays['relay3'];
            const relay9 = relays['relay9'];
            
            let storageState = '';
            let storageStateColor = 'var(--text-color)';
            let storeCharge = false;
            let storeDischarge = false;
            
            if (!relay3 || !relay9) {
                storageStateElement.textContent = 'Waiting for relay data...';
                storageStateElement.style.color = 'var(--text-muted)';
            } else {
                const relay3State = relay3.state;
                const relay9State = relay9.state;
                
                if (relay3State === 'energized') {
                    storageState = 'Store Charge';
                    storageStateColor = '#17a2b8'; // Blue for "charging"
                    storeCharge = true;
                } else if (relay3State === 'deenergized' && relay9State === 'energized') {
                    storageState = 'Store Discharging';
                    storageStateColor = '#fd7e14'; // Orange for "discharging"
                    storeDischarge = true;
                } else if (relay3State === 'deenergized' && relay9State === 'deenergized') {
                    storageState = 'Store idle';
                    storageStateColor = '#6c757d'; // Gray for "idle"
                } else {
                    storageState = 'Unknown state';
                    storageStateColor = 'var(--text-muted)';
                }
                
                storageStateElement.textContent = storageState;
                storageStateElement.style.color = storageStateColor;
            }
            
            // Calculate combined state
            let combinedState = '';
            let combinedStateColor = 'var(--text-color)';
            
            if (hpOn && storeCharge) {
                combinedState = 'HpOnStoreCharge';
                combinedStateColor = '#28a745'; // Green
            } else if (hpOn && !storeCharge && !storeDischarge) {
                combinedState = 'HpOnStoreOff';
                combinedStateColor = '#17a2b8'; // Blue
            } else if (!hpOn && storeDischarge) {
                combinedState = 'HpOffStoreDischarge';
                combinedStateColor = '#fd7e14'; // Orange
            } else if (!hpOn && !storeCharge && !storeDischarge) {
                combinedState = 'HpOffStoreOff';
                combinedStateColor = '#6c757d'; // Gray
            } else {
                combinedState = 'Unknown combined state';
                combinedStateColor = 'var(--text-muted)';
            }
            
            combinedStateElement.textContent = combinedState;
            combinedStateElement.style.color = combinedStateColor;

            hpStateElement.textContent = '';
            storageStateElement.textContent = '';
        }

        function updateRelayState(payload) {
            // Update individual relay state from MQTT message
            if (payload && payload.relay_name && payload.state) {
                relays[payload.relay_name] = {
                    ...relays[payload.relay_name],
                    state: payload.state
                };
                
                // Update the relay buttons display
                updateRelayButtons();
                
                // Update system state
                updateSystemState();
            }
        }

        function toggleRelay(relayName) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.error('Not connected to server');
                return;
            }

            const message = {
                type: 'relay_control',
                data: {
                    relay_name: relayName,
                    timeout_seconds: 300,
                    user_id: currentUserId
                }
            };
            
            websocket.send(JSON.stringify(message));
            console.log(`Toggling relay ${relayName}`);
        }



        function sendKeepAlive() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.error('Not connected to server');
                return;
            }

            const timeoutMinutes = parseInt(document.getElementById('timeout-input').value) || 5;
            const timeoutSeconds = timeoutMinutes * 60;

            const message = {
                type: 'keepalive',
                data: {
                    timeout_seconds: timeoutSeconds,
                    user_id: currentUserId
                }
            };

            websocket.send(JSON.stringify(message));
            console.log(`Sending keep alive for ${timeoutMinutes} minutes`);
        }

        function sendReleaseControl() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.error('Not connected to server');
                return;
            }

            const message = {
                type: 'release_control',
                data: {}
            };

            websocket.send(JSON.stringify(message));
            console.log('Sending release control');
        }

        function updateMonitoringTables(snapshotData) {
            console.log('Updating monitoring tables with snapshot data:', snapshotData);
            console.log('LatestReadingList:', snapshotData.LatestReadingList);
            console.log('LatestStateList:', snapshotData.LatestStateList);
            
            // Update thermostat table
            updateThermostatTable(snapshotData);
            
            // Update power and pump table
            updatePowerPumpTable(snapshotData);
        }

        function updateThermostatTable(snapshotData) {
            const tbody = document.getElementById('thermostat-tbody');
            if (!tbody || !snapshotData.LatestReadingList) return;
            
            // Use dynamic thermostat names from the server
            if (!thermostatNames || thermostatNames.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="border: 1px solid var(--border-color); padding: 8px; text-align: center;">Loading thermostat names...</td></tr>';
                return;
            }
            
            // Create zone mappings dynamically from thermostat names
            const zones = thermostatNames.map((name, index) => ({
                key: `zone${index + 1}-${name}`,
                display: `zone${index + 1}-${name}`
            }));
            
            // Create a lookup map for readings
            const readingsMap = {};
            snapshotData.LatestReadingList.forEach(reading => {
                readingsMap[reading.ChannelName] = reading;
            });
            
            // Debug: Log all available readings
            console.log('Available readings for thermostat table:', Object.keys(readingsMap));
            console.log('Using thermostat zones:', zones);
            
            tbody.innerHTML = '';
            
            zones.forEach(zone => {
                // Look for temperature and set point readings for this zone using actual channel names
                const tempReading = readingsMap[`${zone.key}-temp`];
                const setPointReading = readingsMap[`${zone.key}-set`];
                const stateReading = readingsMap[`${zone.key}-state`];
                
                // Temperature values are in degrees Fahrenheit * 10
                const tempF = tempReading ? (tempReading.Value / 1000).toFixed(1) : 'N/A';
                const setPointF = setPointReading ? (setPointReading.Value / 1000).toFixed(1) : 'N/A';
                const state = stateReading ? (stateReading.Value > 0 ? 'heating' : 'idle') : 'idle';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="border: 1px solid var(--border-color); padding: 8px;">${zone.display}</td>
                    <td style="border: 1px solid var(--border-color); padding: 8px;">${setPointF}Â°F</td>
                    <td style="border: 1px solid var(--border-color); padding: 8px;">${tempF}Â°F</td>
                    <td style="border: 1px solid var(--border-color); padding: 8px;">${state}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePowerPumpTable(snapshotData) {
            if (!snapshotData.LatestReadingList) return;
            
            // Create a lookup map for readings
            const readingsMap = {};
            snapshotData.LatestReadingList.forEach(reading => {
                readingsMap[reading.ChannelName] = reading;
            });
            
            // Debug: Log all available readings
            console.log('Available readings for power/pump table:', Object.keys(readingsMap));
            
            // Update HP Power table
            updateHpPowerTable(readingsMap);
            
            // Update Pump table
            updatePumpTable(readingsMap);
        }

        function updateHpPowerTable(readingsMap) {
            const tbody = document.getElementById('hp-power-tbody');
            if (!tbody) return;
            
            // Get power readings using actual channel names
            const hpOduReading = readingsMap['hp-odu-pwr'];
            const hpIduReading = readingsMap['hp-idu-pwr'];
            const hpTotalReading = hpOduReading && hpIduReading ? 
                { Value: hpOduReading.Value + hpIduReading.Value } : null;
            
            // Convert power from watts to kW
            const hpTotalKw = hpTotalReading ? (hpTotalReading.Value / 1000).toFixed(2) : '0.00';
            const hpOduKw = hpOduReading ? (hpOduReading.Value / 1000).toFixed(2) : '0.00';
            const hpIduKw = hpIduReading ? (hpIduReading.Value / 1000).toFixed(2) : '0.00';
            
            tbody.innerHTML = '';
            
            // Outdoor row
            const row2 = document.createElement('tr');
            row2.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 8px;">Outdoor unit</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${hpOduKw}</td>
            `;
            tbody.appendChild(row2);
            
            // Indoor row
            const row3 = document.createElement('tr');
            row3.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 8px;">Indoor unit</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${hpIduKw}</td>
            `;
            tbody.appendChild(row3);

            // HP Total row
            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 8px;">Total</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${hpTotalKw}</td>
            `;
            tbody.appendChild(row1);
        }

        function updatePumpTable(readingsMap) {
            const tbody = document.getElementById('pump-tbody');
            if (!tbody) return;
            
            // Get pump readings using actual channel names
            const primaryFlowReading = readingsMap['primary-flow'];
            const primaryPowerReading = readingsMap['primary-pump-pwr'];
            const distFlowReading = readingsMap['dist-flow'];
            const distPowerReading = readingsMap['dist-pump-pwr'];
            const storeFlowReading = readingsMap['store-flow'];
            const storePowerReading = readingsMap['store-pump-pwr'];
            
            tbody.innerHTML = '';
            
            // Primary pump row
            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 8px;">Primary</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${primaryFlowReading ? (primaryFlowReading.Value / 100).toFixed(1) : '0.0'}</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${primaryPowerReading && primaryPowerReading.Value > 0 ? primaryPowerReading.Value.toFixed(1) : '0.0'}</td>
            `;
            tbody.appendChild(row1);
            
            // Distribution pump row
            const row2 = document.createElement('tr');
            row2.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 8px;">Distribution</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${distFlowReading ? (distFlowReading.Value / 100).toFixed(1) : '0.0'}</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${distPowerReading && distPowerReading.Value > 0 ? distPowerReading.Value.toFixed(1) : '0.0'}</td>
            `;
            tbody.appendChild(row2);
            
            // Storage pump row
            const row3 = document.createElement('tr');
            row3.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 8px;">Store</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${storeFlowReading ? (storeFlowReading.Value / 100).toFixed(1) : '0.0'}</td>
                <td style="border: 1px solid var(--border-color); padding: 8px;">${storePowerReading && storePowerReading.Value > 0 ? storePowerReading.Value.toFixed(1) : '0.0'}</td>
            `;
            tbody.appendChild(row3);
        }

        // Connect when page loads
        window.onload = function() {
            connectWebSocket();
        };
    </script>
    </div>
</body>
</html>
